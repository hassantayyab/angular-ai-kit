<div [class]="containerClasses()">
  <!-- Hidden file input for attachments -->
  <input
    #fileInput
    type="file"
    multiple
    hidden
    (change)="handleFileSelect($event)"
    aria-hidden="true"
  />

  <!-- Suggestions Template -->
  <ng-template #suggestionsTemplate>
    <div
      class="flex flex-wrap items-center justify-center gap-2"
      role="group"
      aria-label="Suggested prompts"
    >
      @for (suggestion of suggestions(); track suggestion.label) {
        <button
          type="button"
          hlmBtn
          variant="outline"
          class="rounded-full px-3 text-xs"
          (click)="handleSuggestionClick(suggestion)"
          [attr.aria-label]="'Use suggestion: ' + suggestion.label"
        >
          @if (suggestion.icon) {
            <span>{{ suggestion.icon }}</span>
          }
          {{ suggestion.label }}
        </button>
      }
    </div>
  </ng-template>

  <!-- Quick Suggestions (top position) -->
  @if (suggestionsVisible() && suggestionsPosition() === 'top') {
    <div class="mb-3">
      <ng-container *ngTemplateOutlet="suggestionsTemplate" />
    </div>
  }

  <!-- Main Input Group -->
  <div hlmInputGroup class="rounded-2xl">
    <!-- Block-start: Context button with popover -->
    @if (showContextButton()) {
      <div hlmInputGroupAddon align="block-start">
        <hlm-popover sideOffset="5">
          <button
            hlmInputGroupButton
            hlmPopoverTrigger
            variant="outline"
            class="rounded-full"
            [size]="hasContext() ? 'icon-sm' : 'sm'"
            aria-label="Add context"
          >
            <ng-icon hlm name="lucideAtSign" size="sm" />
            @if (!hasContext()) {
              <span class="hidden sm:inline">Add context</span>
            }
          </button>

          <div
            hlmPopoverContent
            class="rounded-xl p-0"
            *brnPopoverContent="let ctx"
          >
            <hlm-command class="rounded-2xl">
              <hlm-command-search class="border-border">
                <ng-icon
                  hlm
                  name="lucideSearch"
                  size="sm"
                  class="shrink-0 opacity-50"
                />
                <input
                  type="text"
                  hlm-command-search-input
                  placeholder="Search pages, files..."
                />
              </hlm-command-search>

              <hlm-command-list>
                <!-- Pages -->
                <hlm-command-group id="pages">
                  <hlm-command-group-label>Pages</hlm-command-group-label>
                  @for (item of availableContextItems(); track item.title) {
                    @if (item.type === 'page') {
                      <button
                        hlm-command-item
                        [value]="item.title"
                        (click)="addContext(item); ctx.close()"
                      >
                        <span class="mr-2">{{ item.icon }}</span>
                        {{ item.title }}
                      </button>
                    }
                  }
                </hlm-command-group>

                <!-- Files -->
                <hlm-command-group id="files">
                  <hlm-command-group-label>Files</hlm-command-group-label>
                  @for (item of availableContextItems(); track item.title) {
                    @if (item.type === 'file') {
                      <button
                        hlm-command-item
                        [value]="item.title"
                        (click)="addContext(item); ctx.close()"
                      >
                        <span class="mr-2">{{ item.icon }}</span>
                        {{ item.title }}
                      </button>
                    }
                  }
                </hlm-command-group>
              </hlm-command-list>

              <!-- Empty state -->
              <div *brnCommandEmpty hlmCommandEmpty>No results found.</div>
            </hlm-command>
          </div>
        </hlm-popover>

        <!-- Selected context badges -->
        <div class="no-scrollbar -m-1.5 flex gap-1 overflow-y-auto p-1.5">
          @for (context of selectedContexts(); track context.title) {
            <button
              hlmInputGroupButton
              variant="secondary"
              class="rounded-full"
              size="sm"
              (click)="removeContext(context)"
            >
              <span class="mr-1">{{ context.icon }}</span>
              {{ context.title }}
              <ng-icon hlm name="lucideX" size="sm" class="ml-1" />
            </button>
          }
        </div>
      </div>
    }

    <!-- Textarea -->
    <textarea
      hlmInputGroupTextarea
      #textareaRef
      [placeholder]="placeholder()"
      [disabled]="disabled()"
      [value]="inputValue()"
      (input)="handleInput($event)"
      (keydown)="handleKeydown($event)"
      aria-label="Message input"
      aria-describedby="keyboard-hint"
    ></textarea>
    <span id="keyboard-hint" class="sr-only">
      Press Enter to send, Shift+Enter for new line, Escape to clear
    </span>

    <!-- Block-end: Toolbar -->
    <div hlmInputGroupAddon align="block-end" class="no-scrollbar gap-1">
      <!-- Attachment -->
      @if (showAttachmentButton()) {
        <button
          hlmInputGroupButton
          class="rounded-full"
          size="icon-sm"
          aria-label="Attach file"
          (click)="triggerFileInput()"
        >
          <ng-icon hlm name="lucidePaperclip" size="sm" />
        </button>
      }

      <!-- Research toggle - subtle active state -->
      @if (showResearchButton()) {
        <button
          hlmInputGroupButton
          class="data-[active=true]:bg-accent data-[active=true]:text-accent-foreground rounded-full"
          size="sm"
          [attr.data-active]="researchMode()"
          [attr.aria-pressed]="researchMode()"
          aria-label="Toggle research mode"
          (click)="toggleResearch()"
        >
          <ng-icon hlm name="lucideLightbulb" size="sm" />
          <span class="hidden sm:inline">Research</span>
        </button>
      }

      <!-- Model selector dropdown -->
      @if (showModelName()) {
        <button
          hlmInputGroupButton
          class="rounded-full"
          size="sm"
          [hlmDropdownMenuTrigger]="modelMenu"
        >
          {{ selectedModel().name }}
        </button>
        <ng-template #modelMenu>
          <hlm-dropdown-menu
            class="border-border w-50 rounded-xl **:data-[slot=dropdown-menu-checkbox-item]:rounded-lg"
          >
            <hlm-dropdown-menu-group>
              <hlm-dropdown-menu-label class="text-muted-foreground text-xs">
                Select Mode
              </hlm-dropdown-menu-label>
              @for (model of modelOptions; track model.name) {
                <button
                  hlmDropdownMenuCheckbox
                  [checked]="selectedModel().name === model.name"
                  (click)="selectModel(model)"
                >
                  <span>{{ model.name }}</span>
                  @if (model.badge) {
                    <span
                      hlmBadge
                      variant="secondary"
                      class="ml-2 h-5 rounded-sm bg-blue-100 px-1 text-xs text-blue-800 dark:bg-blue-900 dark:text-blue-100"
                    >
                      {{ model.badge }}
                    </span>
                  }
                  <hlm-dropdown-menu-checkbox-indicator />
                </button>
              }
            </hlm-dropdown-menu-group>
          </hlm-dropdown-menu>
        </ng-template>
      }

      <!-- Sources dropdown - icon only on mobile -->
      @if (showSourcesButton()) {
        <button
          hlmInputGroupButton
          class="rounded-full"
          size="sm"
          [hlmDropdownMenuTrigger]="sourcesMenu"
        >
          <ng-icon hlm name="lucideGlobe" size="sm" />
          <span class="hidden sm:inline">All Sources</span>
        </button>
        <ng-template #sourcesMenu>
          <hlm-dropdown-menu
            class="border-border w-75 rounded-xl **:data-[slot=dropdown-menu-item]:rounded-lg"
          >
            <hlm-dropdown-menu-group>
              <!-- Web Search toggle -->
              <button hlmDropdownMenuItem (click)="$event.stopPropagation()">
                <label
                  for="web-search"
                  (click)="$event.stopPropagation()"
                  class="flex flex-1 items-center"
                >
                  <ng-icon hlm name="lucideGlobe" class="mr-2" size="sm" />
                  Web Search
                  <hlm-switch
                    id="web-search"
                    class="ml-auto"
                    [checked]="webSearchEnabled()"
                    (click)="$event.stopPropagation(); toggleWebSearch()"
                  />
                </label>
              </button>
            </hlm-dropdown-menu-group>
            <hlm-dropdown-menu-separator />
            <hlm-dropdown-menu-group>
              <!-- Apps & Integrations toggle -->
              <button hlmDropdownMenuItem (click)="$event.stopPropagation()">
                <label
                  for="app-integrations"
                  class="flex flex-1 items-center"
                  (click)="$event.stopPropagation()"
                >
                  <ng-icon hlm name="lucideBlocks" class="mr-2" size="sm" />
                  Apps and Integrations
                  <hlm-switch
                    id="app-integrations"
                    class="ml-auto"
                    [checked]="appsIntegrationsEnabled()"
                    (click)="$event.stopPropagation(); toggleAppsIntegrations()"
                  />
                </label>
              </button>
              <button hlmDropdownMenuItem>
                <ng-icon hlm name="lucideBookOpen" size="sm" />
                Help Center
              </button>
            </hlm-dropdown-menu-group>
            <hlm-dropdown-menu-separator />
            <hlm-dropdown-menu-group>
              <button hlmDropdownMenuItem>
                <ng-icon hlm name="lucidePlus" size="sm" />
                Connect Apps
              </button>
              <hlm-dropdown-menu-label class="text-muted-foreground text-xs">
                We'll only search in the sources selected here.
              </hlm-dropdown-menu-label>
            </hlm-dropdown-menu-group>
          </hlm-dropdown-menu>
        </ng-template>
      }

      <!-- Spacer to push mic and send to right on desktop -->
      <div class="flex-1"></div>

      <!-- Mic button -->
      @if (showMicButton()) {
        <button
          hlmInputGroupButton
          class="rounded-full"
          size="icon-sm"
          [class.animate-pulse]="isRecording()"
          [class.text-red-500]="isRecording()"
          [attr.aria-pressed]="isRecording()"
          aria-label="Voice input"
          (click)="toggleMic()"
        >
          <ng-icon hlm name="lucideMic" size="sm" />
        </button>
      }

      <!-- Send button -->
      <button
        hlmInputGroupButton
        [variant]="canSend() ? 'default' : 'secondary'"
        class="rounded-full"
        size="icon-sm"
        [disabled]="!canSend()"
        [attr.aria-disabled]="!canSend()"
        aria-label="Send message"
        (click)="handleSend()"
      >
        <ng-icon hlm name="lucideArrowUp" size="sm" />
      </button>
    </div>
  </div>

  <!-- Quick Suggestions (bottom position) -->
  @if (suggestionsVisible() && suggestionsPosition() === 'bottom') {
    <div class="mt-3">
      <ng-container *ngTemplateOutlet="suggestionsTemplate" />
    </div>
  }
</div>
